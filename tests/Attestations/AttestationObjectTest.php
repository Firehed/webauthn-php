<?php

declare(strict_types=1);

namespace Firehed\WebAuthn\Attestations;

use Firehed\WebAuthn\BinaryString;

/**
 * @covers Firehed\WebAuthn\Attestations\AttestationObject
 */
class AttestationObjectTest extends \PHPUnit\Framework\TestCase
{
    public function testParsingCBOR(): void
    {
        $cbor = BinaryString::fromBytes([
            163, 99, 102, 109, 116, 104, 102, 105,
            100, 111, 45, 117, 50, 102, 103, 97,
            116, 116, 83, 116, 109, 116, 162, 99,
            115, 105, 103, 88, 71, 48, 69, 2,
            32, 125, 241, 18, 179, 63, 148, 87,
            33, 101, 87, 90, 193, 184, 205, 46,
            140, 178, 227, 125, 156, 130, 101, 119,
            198, 219, 226, 228, 245, 150, 114, 202,
            185, 2, 33, 0, 231, 58, 231, 199,
            193, 59, 137, 101, 112, 10, 118, 58,
            7, 87, 103, 230, 182, 199, 58, 172,
            172, 67, 207, 172, 189, 216, 228, 194,
            202, 152, 27, 111, 99, 120, 53, 99,
            129, 89, 2, 49, 48, 130, 2, 45,
            48, 130, 1, 23, 160, 3, 2, 1,
            2, 2, 4, 5, 182, 5, 121, 48,
            11, 6, 9, 42, 134, 72, 134, 247,
            13, 1, 1, 11, 48, 46, 49, 44,
            48, 42, 6, 3, 85, 4, 3, 19,
            35, 89, 117, 98, 105, 99, 111, 32,
            85, 50, 70, 32, 82, 111, 111, 116,
            32, 67, 65, 32, 83, 101, 114, 105,
            97, 108, 32, 52, 53, 55, 50, 48,
            48, 54, 51, 49, 48, 32, 23, 13,
            49, 52, 48, 56, 48, 49, 48, 48,
            48, 48, 48, 48, 90, 24, 15, 50,
            48, 53, 48, 48, 57, 48, 52, 48,
            48, 48, 48, 48, 48, 90, 48, 40,
            49, 38, 48, 36, 6, 3, 85, 4,
            3, 12, 29, 89, 117, 98, 105, 99,
            111, 32, 85, 50, 70, 32, 69, 69,
            32, 83, 101, 114, 105, 97, 108, 32,
            57, 53, 56, 49, 53, 48, 51, 51,
            48, 89, 48, 19, 6, 7, 42, 134,
            72, 206, 61, 2, 1, 6, 8, 42,
            134, 72, 206, 61, 3, 1, 7, 3,
            66, 0, 4, 253, 184, 222, 179, 161,
            237, 112, 235, 99, 108, 6, 110, 182,
            0, 105, 150, 165, 249, 112, 252, 181,
            219, 136, 252, 59, 48, 93, 65, 229,
            150, 111, 12, 27, 84, 184, 82, 254,
            240, 160, 144, 126, 209, 127, 59, 255,
            194, 157, 77, 50, 27, 156, 248, 168,
            74, 44, 234, 160, 56, 202, 189, 53,
            213, 152, 222, 163, 38, 48, 36, 48,
            34, 6, 9, 43, 6, 1, 4, 1,
            130, 196, 10, 2, 4, 21, 49, 46,
            51, 46, 54, 46, 49, 46, 52, 46,
            49, 46, 52, 49, 52, 56, 50, 46,
            49, 46, 49, 48, 11, 6, 9, 42,
            134, 72, 134, 247, 13, 1, 1, 11,
            3, 130, 1, 1, 0, 126, 211, 251,
            108, 204, 37, 32, 19, 248, 47, 33,
            140, 42, 55, 218, 96, 49, 210, 14,
            127, 48, 129, 218, 252, 174, 177, 40,
            252, 127, 155, 35, 57, 20, 191, 182,
            77, 97, 53, 241, 124, 226, 33, 250,
            118, 79, 69, 62, 241, 39, 58, 140,
            233, 101, 149, 100, 66, 187, 47, 30,
            71, 72, 63, 115, 125, 203, 201, 139,
            88, 83, 119, 254, 245, 11, 39, 14,
            2, 137, 248, 132, 54, 241, 173, 207,
            73, 178, 98, 30, 229, 227, 2, 223,
            85, 91, 154, 183, 66, 114, 224, 105,
            249, 24, 20, 155, 61, 236, 79, 18,
            34, 139, 16, 192, 248, 141, 227, 106,
            245, 138, 116, 187, 68, 43, 133, 174,
            0, 83, 100, 189, 166, 112, 32, 88,
            252, 31, 45, 135, 155, 83, 1, 17,
            234, 96, 232, 108, 99, 241, 127, 165,
            148, 76, 200, 63, 10, 162, 105, 132,
            139, 62, 227, 136, 166, 192, 158, 107,
            5, 149, 63, 203, 184, 244, 126, 131,
            162, 126, 0, 114, 166, 60, 50, 173,
            100, 134, 78, 146, 109, 113, 18, 250,
            25, 151, 247, 131, 150, 86, 251, 179,
            43, 232, 247, 136, 157, 15, 1, 69,
            81, 154, 39, 175, 221, 142, 70, 176,
            76, 164, 41, 13, 133, 64, 182, 52,
            184, 134, 22, 30, 117, 136, 200, 98,
            153, 220, 221, 100, 53, 209, 103, 138,
            58, 111, 10, 116, 130, 156, 77, 211,
            247, 12, 53, 36, 209, 221, 241, 109,
            120, 173, 210, 27, 100, 104, 97, 117,
            116, 104, 68, 97, 116, 97, 88, 196,
            73, 150, 13, 229, 136, 14, 140, 104,
            116, 52, 23, 15, 100, 118, 96, 91,
            143, 228, 174, 185, 162, 134, 50, 199,
            153, 92, 243, 186, 131, 29, 151, 99,
            65, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 64, 236,
            58, 219, 22, 123, 115, 98, 124, 11,
            0, 207, 244, 106, 41, 249, 202, 71,
            106, 58, 209, 209, 243, 172, 181, 172,
            43, 40, 230, 31, 122, 155, 134, 233,
            100, 181, 1, 244, 209, 87, 196, 229,
            209, 179, 114, 159, 228, 220, 236, 239,
            36, 27, 45, 159, 223, 209, 245, 214,
            39, 125, 27, 143, 115, 48, 36, 165,
            1, 2, 3, 38, 32, 1, 33, 88,
            32, 76, 76, 91, 252, 118, 191, 197,
            203, 26, 81, 220, 70, 76, 103, 244,
            203, 236, 171, 119, 144, 99, 196, 84,
            9, 147, 188, 195, 151, 228, 114, 184,
            75, 34, 88, 32, 41, 100, 179, 87,
            130, 254, 107, 200, 157, 124, 49, 10,
            98, 63, 119, 233, 77, 194, 239, 205,
            218, 147, 101, 51, 204, 147, 69, 30,
            246, 195, 159, 113,
        ]);
        $ao = new AttestationObject($cbor);

        self::assertTrue($cbor->equals($ao->getCbor()));
        // These assertions are slightly superficial, but it does serve as an
        // integration test that the data threads through.

        $ad = $ao->getAuthenticatorData();
        self::assertTrue($ad->isUserPresent(), 'user present');
        self::assertFalse($ad->isUserVerified(), 'user verified');
        self::assertSame(
            hash('sha256', 'localhost', true),
            $ad->getRpIdHash()->unwrap(),
            'RP ID hash',
        );
        self::assertSame(0, $ad->getSignCount(), 'sign count');

        $credential = $ad->getAttestedCredentialData();
        // TODO: check keypair?
    }

    public function testVerify(): void
    {
        self::markTestIncomplete();
    }
}
